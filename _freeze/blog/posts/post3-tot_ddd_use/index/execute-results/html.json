{
  "hash": "fd1d429e2ea5ca1bdd8838790bb4143a",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Evolution in DDD use of Diabetes Drugs over time\"\nauthor: \"Henrik Vitus Bering Laursen\"\ndate: \"2024-09-30\" \ncategories: \n  - code\n  - analysis\n  - exploration\n  - cost\n  - drugs\nimage: thumbnail.png\nfreeze: true\n---\n\n## Drug utilisation over time\n\nMy two previous posts examined data available from [medstat](medstat.dk) and were focused on those datasets and specifically the turnover of specific drug classes.\n\nHere, I wish to demonstrate a different type of publicly available data, still related to prescription data.\n\nThis is data regarding drug prices, and can be found on The Danish Health Data Authority's website [here](https://www.esundhed.dk/Emner/Laegemidler/Medicinpriser).\n\nDanish drug prices are by and large renegotiated every 14 days. Therefore, the dataset is updated accordingly. I will use the data from the most [recent update](https://www.esundhed.dk/-/media/Files/Publikationer/Emner/Laegemidler/Medicinpriser/2024/lmpriser_eSundhed_240916.ashx) as of the start of making this post.\n\nLooking at it post hoc, I used the following packages:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(readxl)\nlibrary(httr)\nlibrary(stringr)\nlibrary(extrafont)\n# install.packages(\"ggpubr\")\n# library(gridExtra)\n# library(ggpubr)\n```\n:::\n\n\n### Fetching the data\n\nI had some initial trouble figuring out how to download the file. What kept me from figuring it out was not realising that the file from the [link](https://www.esundhed.dk/-/media/Files/Publikationer/Emner/Laegemidler/Medicinpriser/2024/lmpriser_eSundhed_240916.ashx) was a zip file containing an excel file.\n\nApparently, \"The extension .ashx doesn't specify the file format but rather that a server-side handler is being used to serve the content.\", as chatGPT puts it. I have no gained the understanding that .ashx is just some sort of framework that serves up the data, not a file type.\n\nThis leads to the following code necessary to download the data. Code is just for show.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# URL of the .ashx file \nurl <- \"https://www.esundhed.dk/-/media/Files/Publikationer/Emner/Laegemidler/Medicinpriser/2024/lmpriser_eSundhed_240916.ashx\"\n\n# Define a path in my local datafolder, used as described in the first post about medstat data\ndatapath <- \"C:/Users/henri/Documents/data-publicdataprojects\"\n\n# Define the path where the ZIP file will be saved\nzip_destfile <- paste0(datapath,\"lmpriser_eSundhed_240916.zip\")\n\n# Download the ZIP file\ndownload.file(url, zip_destfile, mode = \"wb\")\n\n# Unzip the file\nunzip(zip_destfile, exdir = paste0(datapath,\"unzipped_files\"))\n\n# Check the unzipped files\nlist.files(paste0(datapath,\"unzipped_files\"))\n\n# check which sheet to import from the excel file\nsheet_names <- excel_sheets(paste0(datapath,\"unzipped_files/lmpriser_eSundhed_240916.xlsx\"))\n```\n:::\n\n\nAnd then I import the file:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Read the excel file\ndatapath <- \"C:/Users/henri/Documents/data-publicdataprojects\"\ndf_ddd <- read_excel(paste0(datapath,\"unzipped_files/lmpriser_eSundhed_240916.xlsx\"), sheet = \"lmpriser_eSundhed_240916\")\n\nhead(df_ddd)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 144\n  ATC    Lægemiddel Indholdsstof Varenummer Pakning Styrke Form  Firma Indikator\n  <chr>  <chr>      <chr>        <chr>      <chr>   <chr>  <chr> <chr> <chr>    \n1 A01AA… Duraphat   Natriumfluo… 066411     51 g    5 mg/g tand… Colg… AIP      \n2 A01AA… Duraphat   Natriumfluo… 066411     51 g    5 mg/g tand… Colg… AUP      \n3 A01AA… Duraphat   Natriumfluo… 066411     51 g    5 mg/g tand… Colg… DDD      \n4 A01AA… Duraphat   Natriumfluo… 066411     51 g    5 mg/g tand… Colg… AUP_pr_D…\n5 A01AA… Duraphat   Natriumfluo… 066422     3 x 51… 5 mg/g tand… Colg… AIP      \n6 A01AA… Duraphat   Natriumfluo… 066422     3 x 51… 5 mg/g tand… Colg… AUP      \n# ℹ 135 more variables: `20190729` <dbl>, `20190812` <dbl>, `20190826` <dbl>,\n#   `20190909` <dbl>, `20190923` <dbl>, `20191007` <dbl>, `20191021` <dbl>,\n#   `20191104` <dbl>, `20191118` <dbl>, `20191202` <dbl>, `20191216` <dbl>,\n#   `20191230` <dbl>, `20200113` <dbl>, `20200127` <dbl>, `20200210` <dbl>,\n#   `20200224` <dbl>, `20200309` <dbl>, `20200323` <dbl>, `20200406` <dbl>,\n#   `20200420` <dbl>, `20200504` <dbl>, `20200518` <dbl>, `20200601` <dbl>,\n#   `20200615` <dbl>, `20200629` <dbl>, `20200713` <dbl>, `20200727` <dbl>, …\n```\n\n\n:::\n:::\n\n\n### Cleaning the data\n\nJust as the post, I want to focus on drugs used for diabetes. So I keep only the observations with A10A and A10B:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Cleaning it in one set of operations\ndf_ddd_A10 <- df_ddd |> \n# Filter for just A10A and A10B, and keep just prp per ddd \n  filter(\n    str_detect(ATC,(\"^A10B\")) | str_detect(ATC,(\"^A10A\")), \n    Indikator == \"AUP_pr_DDD\") |> \n  # Select variables\n  select(ATC, Indholdsstof, Lægemiddel, starts_with(\"20\")) |>\n  # Pivot the data so that the variable columns that contain time are contained in one variable column\n  pivot_longer(\n    cols = starts_with(\"20\"),\n    names_to = \"Tid\",\n    values_to = \"prpddd\") |> \n  mutate(\n    Tid = ymd(Tid)) |>\n  # group_by(tid) |>  DELETE??\n  # mutate(\n  #   hip_ddd = max(prpddd), # hip_ddd = maxpris per ddd\n  #   lop_ddd = min(prpddd) # lop_ddd = minpris per ddd\n  # ) |> \n  # ungroup() |> \n  filter(\n    !is.na(prpddd)\n  )\n\n# And translate the colnames to english for good measure\nhead(df_ddd_A10)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 5\n  ATC     Indholdsstof    Lægemiddel Tid        prpddd\n  <chr>   <chr>           <chr>      <date>      <dbl>\n1 A10AB01 Insulin (human) Actrapid   2019-07-29   6.48\n2 A10AB01 Insulin (human) Actrapid   2019-08-12   6.48\n3 A10AB01 Insulin (human) Actrapid   2019-08-26   6.48\n4 A10AB01 Insulin (human) Actrapid   2019-09-09   6.48\n5 A10AB01 Insulin (human) Actrapid   2019-09-23   6.48\n6 A10AB01 Insulin (human) Actrapid   2019-10-07   6.48\n```\n\n\n:::\n\n```{.r .cell-code}\ncolnames(df_ddd_A10) <- c(\n  \"atc\",\n  \"compound\",\n  \"product\",\n  \"time\",\n  \"prpddd\" # Pharmacy Retail Price DDD\n)\nhead(df_ddd_A10)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 5\n  atc     compound        product  time       prpddd\n  <chr>   <chr>           <chr>    <date>      <dbl>\n1 A10AB01 Insulin (human) Actrapid 2019-07-29   6.48\n2 A10AB01 Insulin (human) Actrapid 2019-08-12   6.48\n3 A10AB01 Insulin (human) Actrapid 2019-08-26   6.48\n4 A10AB01 Insulin (human) Actrapid 2019-09-09   6.48\n5 A10AB01 Insulin (human) Actrapid 2019-09-23   6.48\n6 A10AB01 Insulin (human) Actrapid 2019-10-07   6.48\n```\n\n\n:::\n:::\n\n\n### Prepping data for plotting\n\nThe resulting dataset is one with all registered Pharmacy Retail Price per Defined Daily Dose (PRP per DDD) of Drugs in the A10 ATC category, from between 2019-07-29 and 2024-09-16. In other words: from the past 5.1362081 years.\n\nThis is basically a measure of how much it costs to treat a person with the medication with a standard dose, each day, and can be used to compare how much each drug costs to use for treatment. This is used because it can be difficult to compare drugs based on redeemed prescriptions or prices, as some drugs are prescribed differently than others. Also, some drugs have absurdly high prices per pill, as some specialised drugs in oncology and opthalmology, compared to very cheap generic pain killers.\n\nThis is exemplified in the code below.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_ddd_test <- df_ddd |> \n  filter(Indikator == \"AUP\") |> # AUP = Pharmacy Retail Price\n  pivot_longer(\n    cols = starts_with(\"20\"),\n    names_to = \"Tid\",\n    values_to = \"prp\"\n    ) |> \n    summarise(\n    highest_prp = max(prp, na.rm = TRUE),\n    lowest_prp = min(prp, na.rm = TRUE)\n  )\ndf_ddd_test\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 2\n  highest_prp lowest_prp\n        <dbl>      <dbl>\n1    9999990.       7.25\n```\n\n\n:::\n:::\n\n\nI want to present the numbers with inline code, and this can be done easily with the basic R function `format()` and `cat()` which can format the numeric value and concatenate the text.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Format the numbers in base R\nformatted_highest_prp <- format(df_ddd_test$highest_prp, big.mark = \",\", scientific = FALSE)\nformatted_lowest_prp <- format(df_ddd_test$lowest_prp, big.mark = \",\", scientific = FALSE)\n\n# Print the formatted numbers\ncat(\"Highest AUP:\", formatted_highest_prp, \"DKK\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nHighest AUP: 9,999,990 DKK\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Lowest AUP:\", formatted_lowest_prp, \"DKK\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLowest AUP: 7.25 DKK\n```\n\n\n:::\n:::\n\n\nBelow, the numbers are generated with inline code:\n\nThe highest Pharmacy Retail Price is NULL, and the lowest is NULL, which is QUITE a difference.\n\n### Making a plot\n\nNow, back to the retail price per DDD of diabetes drugs. Just as a visual aid, lets compare the most expensive to the cheapest, of the diabetes drugs.\n\nBut before that, a useful thing I picked up from [Meghan Hall's blog](https://meghan.rbind.io/), is putting a consistent theme on your plots. This can be done as below.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(gghighlight)\nlibrary(scales)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'scales'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following object is masked from 'package:purrr':\n\n    discard\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following object is masked from 'package:readr':\n\n    col_factor\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(ggtext)\nlibrary(ggrepel)\n\nhen_theme <- function () { \n  theme_linedraw(base_size=11) %+replace%  \n    theme(\n      panel.background  = element_blank(),\n      plot.background = element_rect(fill = \"white\", color = NA), \n      legend.background = element_rect(fill = \"white\", color = NA),\n      legend.key = element_rect(fill = \"white\", color = NA),\n      axis.ticks = element_blank(),\n      panel.grid.major = element_line(color = \"grey90\", size = 0.3), \n      panel.grid.minor = element_blank(),\n      plot.title.position = \"plot\",\n      plot.title = element_text(size = 16, hjust = 0, vjust = 0.5, \n                                margin = margin(b = 0.2, unit = \"cm\")),\n      plot.subtitle = element_text(size = 10, hjust = 0, vjust = 0.5, \n                                   margin = margin(b = 0.4, unit = \"cm\")),\n      plot.caption = element_text(size = 7, hjust = 1, face = \"italic\", \n                                  margin = margin(t = 0.1, unit = \"cm\")),\n      axis.text.x = element_text(size = 13),\n      axis.text.y = element_text(size = 13)\n    )\n}\n```\n:::\n\n\n<!-- fuld linje theme_linedraw(base_size=11, base_family=\"Calibri\") %+replace%. Gider ikke loade en masse fancy fonts. ikke så vigtigt. Det er besværligt men https://towardsdev.com/simple-guide-changing-fonts-in-ggplot2-with-extrafont-8f5100855f4 kan bruges. -->\n\nThe \"hen_theme\" is then added to future plots, at the end.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# find most expensive \ndf_ddd_A10 |> \n  group_by(atc) |> \n  summarise(\n    highest_prpddd = max(prpddd, na.rm = TRUE),\n    lowest_prpddd = min(prpddd, na.rm = TRUE)\n  ) |>   \n  summarise(\n    most_expensive_atc = atc[which.max(highest_prpddd)],\n    most_expensive_value = max(highest_prpddd),\n    least_expensive_atc = atc[which.min(lowest_prpddd)],\n    least_expensive_value = min(lowest_prpddd)\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 4\n  most_expensive_atc most_expensive_value least_expensive_atc\n  <chr>                             <dbl> <chr>              \n1 A10BX16                            522. A10BB12            \n# ℹ 1 more variable: least_expensive_value <dbl>\n```\n\n\n:::\n\n```{.r .cell-code}\n# plot\nhilo_ddd <- df_ddd_A10 |> \n  filter(atc == \"A10BX16\" | atc == \"A10BB12\") |> \n  select(compound,time,prpddd)\n  \nggplot(hilo_ddd, mapping = aes(x=time,y=prpddd, colour = compound)) +\n  geom_point() +\n  labs(\n    title = \"Cheapest and most expensive A10 drugs\",\n    subtitle = \"by Pharmacy Retail Price per DDD\",\n    y = \"Pharmacy Retail Price per DDD\",\n    x = \"\",\n  ) +\n  hen_theme() + \n  theme(\n    legend.title = element_blank(),\n    legend.position = c(0.8,0.9),\n    legend.background = element_rect(fill= \"white\")\n    )\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: The `size` argument of `element_line()` is deprecated as of ggplot2 3.4.0.\nℹ Please use the `linewidth` argument instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: A numeric `legend.position` argument in `theme()` was deprecated in ggplot2\n3.5.0.\nℹ Please use the `legend.position.inside` argument of `theme()` instead.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\nThis plot tells us that the two drug compounds with the highest and lowest PRP per DDD are Glimepiride, of the [sulfonyurea](https://en.wikipedia.org/wiki/Sulfonylurea) class, and Tirzepatide, a [GIP](https://en.wikipedia.org/wiki/Gastric_inhibitory_polypeptide_receptor) and [GLP1](https://en.wikipedia.org/wiki/GLP-1_receptor_agonist) combination.\n\nNow, I wish to visualise how PRP per DDD changes over time. Below, I create the variables for the minimum and maximum values for each compound.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Make a new var thats floored to months and find the min for each month\ndf_ddd_A10_minmax <- df_ddd_A10 |> \n  mutate(month = floor_date(time,\"month\")) |> \n  group_by(month, atc, compound) |> \n  summarise(\n    a_min_prpddd = min(prpddd, na.rm = TRUE), # \"a_\" is to make it first in the facetwrap later \n    b_max_prpddd = max(prpddd, na.rm = TRUE)) |> \n  ungroup()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`summarise()` has grouped output by 'month', 'atc'. You can override using the\n`.groups` argument.\n```\n\n\n:::\n\n```{.r .cell-code}\nhead(df_ddd_A10_minmax)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 5\n  month      atc     compound         a_min_prpddd b_max_prpddd\n  <date>     <chr>   <chr>                   <dbl>        <dbl>\n1 2019-07-01 A10AB01 Insulin (human)          6.07         9.90\n2 2019-07-01 A10AB04 Insulin lispro           9.8         12.2 \n3 2019-07-01 A10AB05 Insulin aspart           9.66        13.1 \n4 2019-07-01 A10AB06 Insulin glulisin         9.35         9.55\n5 2019-07-01 A10AC01 Insulin (human)          6.07        10.9 \n6 2019-07-01 A10AD01 Insulin (human)          6.34        10.9 \n```\n\n\n:::\n:::\n\n\nAnd now for the grand plot I have planned for this post, which will be an overview of the PRP per DDD for the main drug classes in diabetes type 2 treatment.\n\nFirst, I limit the dataset to only encompass the classes I want to look at.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndfforplot <- df_ddd_A10_minmax |> \n  filter(\n    str_detect(atc,\"^A10BA\") |   # met\n      str_detect(atc,\"^A10BB\") | # sul\n      str_detect(atc,\"^A10BK\") | # sglt2\n      str_detect(atc,\"^A10BJ\") | # glp1\n      str_detect(atc,\"^A10BH\") | # dpp4\n      str_detect(atc,\"^A10BX16\") # tirzepatid, honoured guest\n    )  \n```\n:::\n\n\nThen, I try to make the plots which contain a surmountable amount of information.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Minimum values plot\nplotmin <- ggplot(dfforplot) +\n  geom_line(aes(x = month, y = a_min_prpddd, colour = compound), linewidth = 0.8) +\n  labs(title = \"Minimum PRP per DDD Over Time\",\n       x = \"\",\n       y = \"PRP per DDD\",\n       colour = \"Drug\") +\n  hen_theme()\n# Max\nplotmax <- ggplot(dfforplot) +\n  geom_line(aes(x = month, y = b_max_prpddd, colour = compound), linewidth = 0.8) +\n  labs(title = \"Maximum PRP per DDD Over Time\",\n       x = \"\",\n       y = \"PRP per DDD\",\n       colour = \"Drug\") +\n  hen_theme()\n\nplotmin\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n\n```{.r .cell-code}\nplotmax\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-2.png){width=672}\n:::\n:::\n\n\nNow that is quite the jumble of lines.\n\nI want to do the following:\n\n-   Create a more meaningful colour representation\n-   Look at the outliers separately from the ones staying below 50 and 100, respectively.\n\nFirst, meaningful colour representation.\n\nThe exact amount of different compounds within each class can be found via the code below.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndfforplot |> group_by(atc) |> distinct(compound)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 20 × 2\n# Groups:   atc [20]\n   atc     compound     \n   <chr>   <chr>        \n 1 A10BA02 Metformin    \n 2 A10BB01 Glibenclamid \n 3 A10BB07 Glipizid     \n 4 A10BB09 Gliclazid    \n 5 A10BB12 Glimepirid   \n 6 A10BH01 Sitagliptin  \n 7 A10BH02 Vildagliptin \n 8 A10BH03 Saxagliptin  \n 9 A10BH04 Alogliptin   \n10 A10BH05 Linagliptin  \n11 A10BJ01 Exenatid     \n12 A10BJ02 Liraglutid   \n13 A10BJ03 Lixisenatid  \n14 A10BJ05 Dulaglutid   \n15 A10BJ06 Semaglutid   \n16 A10BK01 Dapagliflozin\n17 A10BK02 Canagliflozin\n18 A10BK03 Empagliflozin\n19 A10BK04 Ertugliflozin\n20 A10BX16 Tirzepatid   \n```\n\n\n:::\n:::\n\n\nNow we can setup a vector with colour mapping using the output from above. Copy and paste it into a text editor to convert it to something useful. There are probably smarter ways to use that output.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# prep colour scheme for drugs\n\ncolour_mapping <- c(\n  # Unique drug\n  \"Metformin\"       = \"#000000\",  # Deep Blue (for uniqueness)\n\n  # Sulfonylureas (reddish colors)\n  \"Glibenclamid\"    = \"#d62728\",  # Red\n  \"Glipizid\"        = \"#e37777\",  # Light Red\n  \"Gliclazid\"       = \"#c13515\",  # Darker Red\n  \"Glimepirid\"      = \"#ff6347\",  # Tomato Red\n\n  # DPP-4 inhibitors (greenish colors)\n  \"Sitagliptin\"     = \"#2ca02c\",  # Green\n  \"Vildagliptin\"    = \"#98df8a\",  # Light Green\n  \"Saxagliptin\"     = \"#34a56f\",  # Teal Green\n  \"Alogliptin\"      = \"#57a774\",  # Medium Green\n  \"Linagliptin\"     = \"#1e7f5f\",  # Dark Green\n\n  # GLP-1 receptor agonists (bluish colors)\n  \"Exenatid\"        = \"#1f77b4\",  # Deep Blue\n  \"Liraglutid\"      = \"#5b9bd5\",  # Light Blue\n  \"Lixisenatid\"     = \"#6495ed\",  # Cornflower Blue\n  \"Dulaglutid\"      = \"#4682b4\",  # Steel Blue\n  \"Semaglutid\"      = \"#4169e1\",  # Royal Blue\n\n  # SGLT2 inhibitors (yellowish and brownish colors)\n  \"Dapagliflozin\"   = \"#ffd700\",  # Gold\n  \"Canagliflozin\"   = \"#e5b33f\",  # Dark Yellow\n  \"Empagliflozin\"   = \"#d9a120\",  # Mustard\n  \"Ertugliflozin\"   = \"#b8860b\",  # Dark Goldenrod\n\n  # Tirzepatide (distinct color)\n  \"Tirzepatid\"      = \"#8b008b\"   # Dark Magenta\n)\n```\n:::\n\n\n```{=html}\n<!-- \nMaybe change line shapes, see ggplot index - \naes_linetype_size_shape {ggplot2} ..\n\nThen i make geom-lines for each atc group ? -->\n```\n\nNow to look at the ones who are not outliers separately to see if the graph is visually meaningful.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntestplot1 <- ggplot(dfforplot |> filter(a_min_prpddd<100), aes(x = month, y = a_min_prpddd, colour = compound)) +\n  geom_line() +\n  scale_colour_manual(values = colour_mapping) +\n  scale_x_continuous(breaks = seq.Date(as.Date(\"2020-01-01\"), as.Date(\"2025-12-01\"), by = \"year\"),\n                     labels = format(seq.Date(as.Date(\"2020-01-01\"), as.Date(\"2025-12-01\"), by = \"year\"), \"%Y\")) +\n  labs(title = \"Minimum Pharmacy Retail Price per DDD, in DKK\",\n       x = \"\",\n       y = \"\",\n       colour = \"Drug\") +\n  hen_theme() \n\ntestplot1\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\nFirst of all, this is a mess. In addition to looking at the outliers separately, I want to do the following:\n\n1.  Sort the legend according to drug class (atc codes)\n2.  Reduce the amount of compounds included\n\nFor (1), y'all need to hold on for dear life because this stuff is an amalgamation of what I have done in my PhD combined with some new things. I will have to explain each part of the code in great detail to even remember how this works.\n\n*The explanations are maybe mostly for me*.\n\nTo achieve that, I will firstly make a variable with a label for each drug class. Then, I will order the compound variable by the class variable. Then I apply cus tom colours to the compound variable.\n\nThe first part is relatively simply done using `case_when()` and knowledge of what classes the ATC codes represent.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndfforplot <- dfforplot |> \n  mutate(class = case_when(\n    substr(atc, 1, 5) == \"A10BA\" ~ \"Metformin\",\n    substr(atc, 1, 5) == \"A10BB\" ~ \"Sulfonylureas\",\n    substr(atc, 1, 5) == \"A10BH\" ~ \"DPP4\",\n    substr(atc, 1, 5) == \"A10BJ\" ~ \"GLP1\",\n    substr(atc, 1, 5) == \"A10BK\" ~ \"SGLT2\",\n    substr(atc, 1, 5) == \"A10BX\" ~ \"Tirzepatide\",\n    TRUE ~ \"Other\"  # For any other unclassified codes\n  ))\n```\n:::\n\n\nFor the second part, I set the order I want, turn the `class` variable into a factor, and then `arrange()` the compounds within each class according to this order. Finally, I turn the compound variable into a factor that is ordered by its unique levels, which correspond to the classes, and check that `compound` has the correct order.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclass_order <- c(\"Metformin\", \"Sulfonylureas\", \"DPP4\", \"GLP1\", \"SGLT2\", \"Tirzepatide\")\ndfforplot <- dfforplot |>\n  mutate(class = factor(class, levels = class_order))  |>\n  arrange(class, compound) |>\n  mutate(compound = factor(compound, levels = unique(compound)))\nprint(levels(dfforplot$compound))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"Metformin\"     \"Glibenclamid\"  \"Gliclazid\"     \"Glimepirid\"   \n [5] \"Glipizid\"      \"Alogliptin\"    \"Linagliptin\"   \"Saxagliptin\"  \n [9] \"Sitagliptin\"   \"Vildagliptin\"  \"Dulaglutid\"    \"Exenatid\"     \n[13] \"Liraglutid\"    \"Lixisenatid\"   \"Semaglutid\"    \"Canagliflozin\"\n[17] \"Dapagliflozin\" \"Empagliflozin\" \"Ertugliflozin\" \"Tirzepatid\"   \n```\n\n\n:::\n:::\n\n\nThe third part is simply remembering the order of classes, and how many compounds are within each class, and then creating a selection of colours via the `colorRampPallette()` function, and then store that in the object `colours_compunds`, to use in the plot.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmet_colours  <- colorRampPalette(c(\"black\"))(1)\nsu_colours  <- colorRampPalette(c(\"pink\",\"darkred\"))(4)\ndpp4_colours   <- colorRampPalette(c(\"green\",\"darkgreen\"))(5) # NB THIS WORKS BECAUSE THE FIRST 5 ARE DPP4, 6 are GLP1, etc etc.\nglp1_colours   <- colorRampPalette(c(\"lightblue\",\"darkblue\"))(5)\nsglt2_colours  <- colorRampPalette(c(\"yellow\",\"#b8860b\"))(4)\ntir_colours  <- colorRampPalette(c(\"#8b008b\"))(1)\ncolours_compounds <- c(met_colours,\n                su_colours,\n                dpp4_colours,  \n                glp1_colours,\n                sglt2_colours,\n                tir_colours) # combine\nbarplot(rep(1,20), col=colours_compounds, border = \"white\", axes = FALSE)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n\nFor (2), I will focus on the three most sold compounds in the latest year and remove the rest to avoid cluttering the plot with information. \n\nI use [Medstat](https://medstat.dk/) as a source, and what I look for is DDD sold in total across the entire healthcare sector, which is incredible easy to extract from the site. The amounts are from when I viewed the site in October 2024. Below, I store a vector of the most three most used compounds (less if class has less compounds).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkept_compounds <- c(\n  \"Metformin\", \n  \"Glipizid\",\n  \"Gliclazid\",\n  \"Glimepirid\",\n  \"Sitagliptin\",\n  \"Vildagliptin\",\n  \"Linagliptin\",\n  \"Liraglutid\",\n  \"Dulaglutid\",\n  \"Semaglutid\",\n  \"Dapagliflozin\",\n  \"Canagliflozin\",\n  \"Empagliflozin\",\n  \"Tirzepatid\"  \n)\n```\n:::\n\n\nNow, lets make plots for the ones that are not outliers. In practice I will do that by just limiting the y axis.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndfforplot |> \n  filter(a_min_prpddd<100\n         & compound %in% kept_compounds) |> \n  ggplot(aes(x = month, y = a_min_prpddd, colour = compound)) +\n  geom_line() +\n  scale_colour_manual(values = colours_compounds) +\n  scale_x_continuous(breaks = seq.Date(as.Date(\"2020-01-01\"), as.Date(\"2025-12-01\"), by = \"year\"),\n                     labels = format(seq.Date(as.Date(\"2020-01-01\"), as.Date(\"2025-12-01\"), by = \"year\"), \"%Y\")) +\n  labs(title = \"Minimum Pharmacy Retail Price per DDD, in DKK\",\n       x = \"\",\n       y = \"\",\n       colour = \"Drug\") +\n  hen_theme() \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n\n**Oops**, I messed up. The colours do not fit anymore. Will fit the colours to the new more limited amount of compounds.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmet_colours  <- colorRampPalette(c(\"black\"))(1)\nsu_colours  <- colorRampPalette(c(\"pink\",\"darkred\"))(3)\ndpp4_colours   <- colorRampPalette(c(\"green\",\"darkgreen\"))(3) # NB THIS WORKS BECAUSE THE FIRST 5 ARE DPP4, 6 are GLP1, etc etc.\nglp1_colours   <- colorRampPalette(c(\"lightblue\",\"darkblue\"))(3)\nsglt2_colours  <- colorRampPalette(c(\"yellow\",\"#b8860b\"))(3)\ntir_colours  <- colorRampPalette(c(\"#8b008b\"))(1)\ncolours_compounds <- c(met_colours,\n                su_colours,\n                dpp4_colours,  \n                glp1_colours,\n                sglt2_colours,\n                tir_colours) # combine\nbarplot(rep(1,15), col=colours_compounds, border = \"white\", axes = FALSE)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\nNow try again.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndfforplot |> \n  filter(a_min_prpddd<100\n         & compound %in% kept_compounds) |> \n  ggplot(aes(x = month, y = a_min_prpddd, colour = compound)) +\n  geom_line() +\n  scale_colour_manual(values = colours_compounds) +\n  scale_x_continuous(breaks = seq.Date(as.Date(\"2020-01-01\"), as.Date(\"2025-12-01\"), by = \"year\"),\n                     labels = format(seq.Date(as.Date(\"2020-01-01\"), as.Date(\"2025-12-01\"), by = \"year\"), \"%Y\")) +\n  labs(title = \"Minimum Pharmacy Retail Price per DDD, in DKK\",\n       x = \"\",\n       y = \"\",\n       colour = \"Drug\") +\n  hen_theme() \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\nNow that looks much better. Now let's make the final graph, using `facet_wrap()` to distinguish between the minimum and maximum PRP per DDD.\n\nTo use `facet_wrap()`, we pivot the dataset before plotting.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndfforplot_pivot <- dfforplot |> \n  pivot_longer(\n    cols = ends_with(\"prpddd\"),\n    names_to = \"ddd\",\n    values_to = \"minmax\"\n  ) |> arrange(minmax)\n\nhead(dfforplot_pivot)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 6\n  month      atc     compound   class         ddd          minmax\n  <date>     <chr>   <fct>      <fct>         <chr>         <dbl>\n1 2019-09-01 A10BB12 Glimepirid Sulfonylureas a_min_prpddd  0.135\n2 2019-08-01 A10BB12 Glimepirid Sulfonylureas a_min_prpddd  0.146\n3 2020-01-01 A10BB12 Glimepirid Sulfonylureas a_min_prpddd  0.155\n4 2020-02-01 A10BB12 Glimepirid Sulfonylureas a_min_prpddd  0.155\n5 2019-11-01 A10BB12 Glimepirid Sulfonylureas a_min_prpddd  0.156\n6 2019-12-01 A10BB12 Glimepirid Sulfonylureas a_min_prpddd  0.156\n```\n\n\n:::\n:::\n\n\nAnd then make the plot.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndfforplot_pivot |> \n  filter(compound %in% kept_compounds) |> \n  ggplot(aes(x = month, y = minmax, colour = compound)) +\n  geom_line() +\n  facet_wrap(\n    ~ddd, \n    scales = \"free\",\n    labeller = labeller(ddd =\n                          c(\"a_min_prpddd\" = \"Minimum\",\n                            \"b_max_prpddd\" = \"Maximum\")\n                        )) +\n  scale_colour_manual(values = colours_compounds) +\n  scale_x_continuous(breaks = seq.Date(as.Date(\"2020-01-01\"), as.Date(\"2025-12-01\"), by = \"year\"),\n                     labels = format(seq.Date(as.Date(\"2020-01-01\"), as.Date(\"2025-12-01\"), by = \"year\"), \"%Y\")) +\n  labs(title = \"Minimum Pharmacy Retail Price per DDD, in DKK\",\n       x = \"\",\n       y = \"\",\n       colour = \"Drug\") +\n  hen_theme() \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-23-1.png){width=672}\n:::\n:::\n\n\nAnd the final, more presentable plot.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndfforplot_pivot |> \n  filter(minmax<100\n         & compound %in% kept_compounds) |> \n  ggplot(aes(x = month, y = minmax, colour = compound)) +\n  geom_line() +\n  facet_wrap(\n    ~ddd, \n    scales = \"free\",\n    labeller = labeller(ddd =\n                          c(\"a_min_prpddd\" = \"Minimum\",\n                            \"b_max_prpddd\" = \"Maximum\")\n                        )) +\n  scale_colour_manual(values = colours_compounds) +\n  scale_x_continuous(breaks = seq.Date(as.Date(\"2020-01-01\"), as.Date(\"2025-12-01\"), by = \"year\"),\n                     labels = format(seq.Date(as.Date(\"2020-01-01\"), as.Date(\"2025-12-01\"), by = \"year\"), \"%Y\")) +\n  labs(\n    title = \"Pharmacy Retail Price per DDD, in DKK\",\n    caption = \"Outliers: Minimum Tirzepatide prices go from\",\n    x = \"\",\n    y = \"\",\n    colour = \"Drug\") +\n  hen_theme() \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-24-1.png){width=672}\n:::\n:::\n\n\nI also want to add information about the outliers on the plot.\n\n**JEG HAR GJORT DET MESTE FÆRDIGT OG VIL BARE GERNE SKRIVE DET RENT SENERE**\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Filter the dataset for Semaglutide and Tirzepatide\nsubset_df <- dfforplot_pivot %>%\n  filter(compound %in% c(\"Semaglutid\", \"Tirzepatid\"))\n\n# Summarise the earliest, latest, highest, and lowest values for each compound\nsummary_df <- subset_df %>%\n  group_by(compound) %>%\n  summarise(\n    earliest_date = min(month),\n    latest_date = max(month),\n    highest_ddd = max(minmax),\n    lowest_ddd = min(minmax),\n    .groups = 'drop'  # Ungroup after summarising\n  )\n\n# View the resulting dataset\nprint(summary_df)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 5\n  compound   earliest_date latest_date highest_ddd lowest_ddd\n  <fct>      <date>        <date>            <dbl>      <dbl>\n1 Semaglutid 2019-07-01    2024-09-01         308.       22.6\n2 Tirzepatid 2024-04-01    2024-09-01         522.      103. \n```\n\n\n:::\n\n```{.r .cell-code}\n# Create a caption string\ncaption_text <- paste(\n  \"Outliers were Semaglutide and Tirzepatide. Lowest PRP per DDD for Semaglutide was\",\n  \"22.6, which increased to 308 in 2024.\",\n  \"For Tirzepatide, the lowest value was 103, and increased to 522 in September of 2024.\"\n  )\n\n# Print caption for verification\nprint(caption_text)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Outliers were Semaglutide and Tirzepatide. Lowest PRP per DDD for Semaglutide was 22.6, which increased to 308 in 2024. For Tirzepatide, the lowest value was 103, and increased to 522 in September of 2024.\"\n```\n\n\n:::\n:::\n\n\nDoublechecking with my older data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_ddd_A10 |> filter(str_detect(compound, \"Tirzepatid\")) |> summarise(haps = min(prpddd))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 1\n   haps\n  <dbl>\n1  103.\n```\n\n\n:::\n\n```{.r .cell-code}\ndf_ddd_A10 |> filter(str_detect(compound, \"Tirzepatid\")) |> summarise(haps = max(prpddd))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 1\n   haps\n  <dbl>\n1  522.\n```\n\n\n:::\n\n```{.r .cell-code}\ndf_ddd_A10 |> filter(str_detect(compound, \"Semaglutid\")) |> summarise(haps = min(prpddd))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 1\n   haps\n  <dbl>\n1  22.6\n```\n\n\n:::\n\n```{.r .cell-code}\ndf_ddd_A10 |> filter(str_detect(compound, \"Semaglutid\")) |> summarise(haps = max(prpddd))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 1\n   haps\n  <dbl>\n1  308.\n```\n\n\n:::\n:::\n\n\nSo that makes the final final plot:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndfforplot_pivot |> \n  filter(minmax<100\n         & compound %in% kept_compounds) |> \n  ggplot(aes(x = month, y = minmax, colour = compound)) +\n  geom_line() +\n  facet_wrap(\n    ~ddd, \n    scales = \"free\",\n    labeller = labeller(ddd =\n                          c(\"a_min_prpddd\" = \"Minimum\",\n                            \"b_max_prpddd\" = \"Maximum\")\n                        )) +\n  scale_colour_manual(values = colours_compounds) +\n  scale_x_continuous(breaks = seq.Date(as.Date(\"2020-01-01\"), as.Date(\"2025-12-01\"), by = \"year\"),\n                     labels = format(seq.Date(as.Date(\"2020-01-01\"), as.Date(\"2025-12-01\"), by = \"year\"), \"%Y\")) +\n  labs(\n    title = \"Pharmacy Retail Price per DDD, in DKK\",\n    caption = caption_text,\n    x = \"\",\n    y = \"\",\n    colour = \"Drug\") +\n  hen_theme() \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-27-1.png){width=672}\n:::\n\n```{.r .cell-code}\nggsave(\"thumbnail.png\", plot = last_plot(), width = 6, height = 4) # saved as thumbnail\n```\n:::\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}